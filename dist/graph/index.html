<!DOCTYPE html><html><head><title>releasetrain.io</title><meta name=viewport content="width=device-width, initial-scale=1.0"><meta charset=UTF-8><meta name=description content="Software Component Version Releases"><meta name=keywords content="Version, Release, Agile"><meta name=author content="Solomon Berhe"><meta http-equiv=refresh content=3600><script async src="https://www.googletagmanager.com/gtag/js?id=UA-79349402-1"></script><script src=./../lib/googleanalytics.js></script><link href=./../reset.css rel=stylesheet><link href=./../app.css rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css rel=stylesheet><script type=text/javascript src=./../lib/jquery-2.2.4.min.js></script></head><body><a target=_blank href=https://github.com/antrunner/releasetrain-client class=github-corner aria-label="View source on GitHub"><svg width=80 height=80 viewbox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden=true><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill=currentColor style="transform-origin: 130px 106px;" class=octo-arm></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill=currentColor class=octo-body></path></svg></a><style>
        #container {
        width: 90%;
        height: 100%;
        position: absolute;
        margin: 0px
    }
    </style><nav><h1><a style="color: #fff" target=_self href=https://releasetrain.io>releasetrain.io</a><br><span class=h7>version 2.1.0</span><br></h1></nav><section style="margin: 0px;margin-left: 25px;width: 350px;position: fixed;"><h3>Ecosystem Uncertainty Score</h3>(max last 50 version releases)<br><br><div style="line-height: 20px; padding-left: 5px;">Components:<span id=nodeId></span></div><div style="line-height: 20px; padding-left: 5px;">Links:<span id=edgeId></span></div><br><div style="line-height: 20px; padding-left: 5px;">Version (all):<span id=versionAllId></span></div><div style="line-height: 20px; padding-left: 5px;"><span class="dot orange"></span>Major:<span id=versionMajorId></span></div><div style="line-height: 20px; padding-left: 5px;"><span class="dot green"></span>Minor:<span id=versionMinorId></span></div><div style="line-height: 20px; padding-left: 5px;"><span class="dot yellow"></span>Patch:<span id=versionPatchId></span></div><div style="line-height: 20px; padding-left: 5px;"><span class="dot red"></span>CVE:<span id=versionCveId></span></div><br><div style="line-height: 20px; padding-left: 5px;">Parsing Error:<span id=versionErrorId></span></div><br><div style="line-height: 20px; padding-left: 5px;">Score:<span id=eScoreId></span></div><div style="line-height: 20px; padding-left: 5px;">Score normalized:<span id=eScoreNormalizedId></span></div></section><section id=container></section><script type=text/javascript src=./../lib/sigma.min.js></script><script type=text/javascript src=./../lib/sigma.canvas.edges.labels.curve.js></script><script type=text/javascript src=./../lib/sigma.canvas.edges.labels.curvedArrow.js></script><script type=text/javascript src=./../lib/sigma.canvas.edges.labels.def.js></script><script>
    const url = "https://releasetrain.io/api";

    const urlParams = new URLSearchParams(window.location.search);
    const q = urlParams.get('q');

    extractData();

    function extractData() {
        console.log("extractData");

        $.ajax({
            url: url + "/v?q=" + q,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                transformData(data);
            }
        });
    }

    function transformData(data) {
        console.log("transformData");

        let target = { "nodes": [], "edges": [] }
        let edge = 0;
        let node = 0;
        let versionsTotal = 0;
        let versionMajor = 0;
        let versionMinor = 0;
        let versionPatch = 0;
        let versionCve = 0;
        let versionError = 0;
        let score_eco = 0;
        let score_eco_normalized = 0;
        let item = 0;
        let components = [];
        let componentSize = {};
        let x = 0;
        let y = 0;
        let t = 0;
        let versionNumber = [];
        let color = "green"

        for (var i = 0; i < data.length; i++) {

            item = data[i];

            versionNumber = item.versionNumber.split(".");

            if (item.versionProductName in componentSize) {
                componentSize[item.versionProductName] = componentSize[item.versionProductName] + 1;
            } else {
                componentSize[item.versionProductName] = 1;
            }

            if (isNaN(versionNumber[0]) === true && item.versionReleaseChannel !== "patch") {
                versionError = versionError + 1;
                continue;
            }

            versionNumber[1] = versionNumber.length === 1 ? 0 : versionNumber[1];
            versionNumber[2] = versionNumber.length === 2 ? 0 : versionNumber[2];

            versionNumber = versionNumber.map(v => Number(v));

            versionPatch = item.versionReleaseChannel === "patch" || versionNumber[2] !== 0 ? versionPatch + 1 : versionPatch;
            versionMinor = versionNumber[1] !== 0 && versionNumber[2] === 0 ? versionMinor + 1 : versionMinor;
            versionMajor = versionNumber[1] === 0 && versionNumber[2] === 0 ? versionMajor + 1 : versionMajor;
            versionCve = item.versionReleaseChannel === "cve" ? versionCve + 1 : versionCve;

            // Create nodes
            if (components.includes(item.versionProductName) === true) {
                for (var j = 0; j < target.nodes.length; j++) {
                    if (target.nodes[j].label.split(" ( count: ")[0] == item.versionProductName) {
                        target.nodes[j].count = target.nodes[j].count + 1;
                        // target.nodes[j].size = target.nodes[j].size + 1;
                        target.nodes[j].label = item.versionProductName + " ( count: " + target.nodes[j].count + " ) ";
                    }
                }
            } else {

                t = 2 * Math.PI * i / 45;
                x = Math.round(40 * Math.cos(t));
                y = Math.round(40 * Math.sin(t));

                item.versionSearchTags = item.versionSearchTags.map(v => v.trim().toLowerCase()); // normalize seearch tags
                item.versionSearchTags = item.versionSearchTags.filter(function(e) { return e !== "production" && e !== "beta" && q.split(",").includes(e) === false }) // remove production / beta edges

                color = versionNumber[1] !== 0 && versionNumber[2] === 0 ? "green" : color;
                color = item.versionReleaseChannel === "patch" || versionNumber[2] !== 0 ? "yellow" : color;
                color = versionNumber[1] === 0 && versionNumber[2] === 0 ? "orange" : color;
                color = item.versionReleaseChannel === "cve" ? "red" : color;

                node = {
                    "color": color,
                    "id": item._id,
                    count: 1,
                    "label": item.versionProductName,
                    "x": x,
                    "y": y,
                    "size": componentSize[item.versionProductName],
                    "versionSearchTags": item.versionSearchTags
                }

                // add edges
                for (var j = 0; j < target.nodes.length; j++) {
                    var tagsArr = target.nodes[j].versionSearchTags.filter(value => item.versionSearchTags.includes(value.trim().toLowerCase()));
                    if (tagsArr.length > 0) {
                        edge = { "id": node.id + "-" + target.nodes[j].id, "source": node.id, "target": target.nodes[j].id, label: tagsArr.includes("cve") ? "" : tagsArr.join(",") }
                        target.edges.push(edge);
                    }

                }

                target.nodes.push(node);
                components.push(item.versionProductName);
            }

        }

        versionsTotal = data.length;

        score_eco = ((5 * versionCve * target.edges.length) + (3 * versionMajor) + (2 * versionPatch) + versionMinor) / versionsTotal;
        score_eco_normalized = score_eco / 10000 * 100;

        score_eco = isNaN(score_eco) === true ? 0 : score_eco;
        score_eco_normalized = isNaN(score_eco_normalized) === true ? 0 : score_eco_normalized;

        document.getElementById("nodeId").innerHTML = target.nodes.length;
        document.getElementById("edgeId").innerHTML = target.edges.length;
        document.getElementById("versionAllId").innerHTML = versionsTotal;
        document.getElementById("versionMajorId").innerHTML = versionMajor;
        document.getElementById("versionMinorId").innerHTML = versionMinor;
        document.getElementById("versionPatchId").innerHTML = versionPatch;
        document.getElementById("versionCveId").innerHTML = versionCve;
        document.getElementById("versionErrorId").innerHTML = versionError;

        document.getElementById("eScoreId").innerHTML = score_eco.toFixed(2);
        document.getElementById("eScoreNormalizedId").innerHTML = score_eco_normalized.toFixed(2) + " ( " + getUncertaintyImpact(score_eco_normalized) + " ) ";

        /*
        for (var j = 0; j < target.nodes.length; j++) {
            if (target.nodes[j].count > 10) {
                target.nodes[j]["color"] = "red";
            }
        }
        */

        loadData(target);
    }

    function loadData(data) {
        console.log("loadData");

        s = new sigma({
            graph: data,
            renderer: {
                container: document.getElementById('container'),
                type: sigma.renderers.canvas,
            },
            settings: {
                drawEdgeLabels: true,
                drawLabels: true,
                batchEdgesDrawing: true,
                defaultLabelColor: '#ccc',
                defaultEdgeColor: "#ccc"
            }
        });

        s.bind('clickNode', function(e) {
            let url = "https://releasetrain.io?q=" + e.data.node.label.split(" ( count: ")[0];
            window.open(url, '_blank').focus();
        });
    }

    function getUncertaintyImpact(score) {

        if (isNaN(score) === true || score === 0) {
            return "NO RESULT";
        }

        if (score < 0.5) {
            return "INSIGNIFICANT";
        } else if (score < 5) {
            return "SIGNIFICANT";
        } else {
            return "SEVERE";
        }
    }
    </script></body></html>