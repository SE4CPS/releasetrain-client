<!DOCTYPE html>
<html>
	<head>
		<!-- <title>releasetrain.io v2.1</title> -->
		<title>releasetrain.io</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<meta name="description" content="Software Component Version Releases">
		<meta name="keywords" content="Version, Release, Agile">
		<meta name="author" content="Solomon Berhe">
		<meta http-equiv="refresh" content="3600"/>
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-79349402-1"></script>
		<script src="./lib/googleanalytics.js"></script>
		<script type="text/javascript" src="./lib/jquery-2.2.4.min.js"></script>
		<script type="text/javascript" src="./lib/select2.min.js"></script>
		<script type="text/javascript" src="./lib/Chart.min.js"></script>
		<script type="text/javascript" src="./lib/everpolate.browserified.min.js"></script>
		<link href="./reset.css" rel="stylesheet" />
		<link href="./lib/Chart.min.css" rel="stylesheet" />
		<link href="./lib/select2.min.css" rel="stylesheet" />
		<link href="./app.css" rel="stylesheet" />	
	</head>
	<body>

	<a target="_blank" href="https://github.com/antrunner/releasetrain-client" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

	<nav>
		<h1>releasetrain.io <br>
			<span class="h7 getTodayDate"></span><br>
			<span class="h7 getComponentCount"></span><br>
			<span class="h7 getVersionCount"></span>
		</h1>
		<h2><a class="desktopOnly" href="./">home</a></h2>
		<h2><a class="desktopOnly" href="./acknowledgement.html">acknowledgement</a></h2>
	</nav>

	<section>
		<nav class="desktopOnly">
			<!-- <a href="#" class="versionListClassLink">List</a>&nbsp;|&nbsp; -->
			<!-- <a href="#" class="versionChartClassLink">Chart</a> &nbsp;|&nbsp; -->
			<!-- <a href="#" class="versionRecClassLink">Release Recommendation</a> -->
		</nav>
		<select class="component-names" name="names[]" multiple="multiple"></select>
		<div class="loadingClass">
			<img src="./img/spinner.gif"></img>
		</div>
		<canvas class="desktopOnly versionChartClassSection" id="versionWeekChartId" height="150" width="400"></canvas>
		<canvas class="desktopOnly versionChartClassSection" id="versionMonthChartId" height="150" width="400"></canvas>
		<canvas class="desktopOnly versionChartClassSection" id="versionYearChartId" height="150" width="400"></canvas>
		<ol class="versionListClassSection"></ol>
	</section>

	<script type="text/javascript">
		$(document).ready(function() {

			// var url =  "http://localhost:3000/api";
			var url =  "https://releasetrain.io/api";
	
			var versionChartClassSection = $('.versionChartClassSection');
			var versionListClassSection = $('.versionListClassSection');

			var versionWeekChartId =  $('#versionWeekChartId');
			var versionMonthChartId = $('#versionMonthChartId');
			var versionYearChartId = $('#versionYearChartId');

			var pageNumParam = 1;
			var componentNameParam = "";
			var currDate = null; // global in order to correctly page version

			var weekChart = null;
			var monthChart = null;
			var yearChart = null;

			var isDisplayList = true;
			var isDisplayChart = false;

			var countToday = 0;

			versionChartClassSection.fadeOut();

			var loader = $('.loadingClass');
			jQuery.ajaxSetup({
			  beforeSend: function() {
			     loader.show();
			  },
			  complete: function(){
			     loader.hide();
			  },
			  success: function() {}
			});

			$(".versionChartClassLink").on('click', function() {
				isDisplayList = false;
				isDisplayChart = true;
				versionListClassSection.fadeOut();
				versionChartClassSection.fadeIn();
				getReleases();
			});
			$(".versionListClassLink").on('click', function() {
				isDisplayList = true;
				isDisplayChart = false;
				versionListClassSection.fadeIn();
				versionChartClassSection.fadeOut();
				getReleases();
			});

			$(document.body).on('touchmove', onScroll); // for mobile
			$(window).on('scroll', onScroll); // for desktop
			$('.component-names').on("change", function(e) {
				pageNumParam = 1 // start from scratch after each selection. 
				componentNameParam = ""; // start from scratch after each selection. 
				var select2DataObjsArr = $(this).select2('data');
				for (var i = 0; i < select2DataObjsArr.length; i++) {
					if (i == 0) {
						componentNameParam = select2DataObjsArr[i].text
					} else {
						componentNameParam +=","+select2DataObjsArr[i].text;
					} 
				}
				getReleases();
			});
			
			getAndRenderComponentList();
			getReleases();
			getVersionCount(); 
			getComponentCount(); 
			getTodayDate();


			// Group version by component for extrapolation
			function groupVersionListByComponent(res) {
				// Documentation https://stackoverflow.com/questions/47875045/chart-js-creating-a-line-graph-using-dates
				// res already sorted by date from newest to oldest
				
				var componentList = {};
				for (var i=0; i<res.length; i++) {
					if (componentList[res[i]["versionProductName"]]) {
						componentList[res[i]["versionProductName"]].push(res[i]);
					} else {
						var component = [];
						component[0] = res[i];
						componentList[res[i]["versionProductName"]] = component;
					}
				}
				forecastVersionListByComponent(componentList);
			}

			function forecastVersionListByComponent(componentList) {
				// var forcastTimestamp; = everpolate.linear(c,xWeek,yWeek)[0];
				var componentForecastList = [];
				var version = {};
				var versionTimestamp = [];
				var versionNumber = [];
				var versionReleaseDateString;
				var versionReleaseDate;
				for (var component in componentList) {
				    if (Object.prototype.hasOwnProperty.call(componentList, component)) {
				        for(var i=0; i<componentList[component].length; i++) {
				        	version = {};
				        	versionReleaseDateString = componentList[component][i]["versionReleaseDate"];
				        	versionReleaseDate = new Date(versionReleaseDateString.substring(0,4),versionReleaseDateString.substring(4,6),versionReleaseDateString.substring(6,8));
				        	versionNumber.push(componentList[component][i]["versionNumber"].split(".").slice(0,2).join("."));
				        	versionTimestamp.push(versionReleaseDate.getTime());

					        version["versionProductBrand"] = componentList[component][i]["versionProductBrand"];
					        version["versionProductName"] = componentList[component][i]["versionProductName"];
					        version["versionProductType"] = componentList[component][i]["versionProductType"];
					        version["versionProductLicense"] = componentList[component][i]["versionProductLicense"];
					        version["versionReleaseNotes"] = componentList[component][i]["versionReleaseNotes"];
					        version["versionReleaseDate"] = componentList[component][i]["versionReleaseDate"];
					        version["versionReleaseComments"] = componentList[component][i]["versionReleaseComments"];
					        version["versionReleaseTags"] = componentList[component][i]["versionReleaseTags"];

				        }
						// version["versionReleaseChannel"] = ;	
					   	// version["versionNumber"] = ;					     			  
				        // everpolate.linear([5,6,7,8,9,6], [1,2], [3,4])[0]
				    }
				}
			}

			function getReleases() {
				pageNumParam = 1;
				if (isDisplayList) {
					$(".versionListClassSection").empty(); // clear version list on change
					getVersionList(); // display version list
				} else if (isDisplayChart) {
					getVersionWeek();
					getVersionMonth();
					getVersionYear();
				} else {
					console.warn("RT :: Invalid display status.")
				}
			}
			function getAndRenderComponentList() {
				$('.component-names').select2({
				    tags: true,
				    multiple: true,
				    tokenSeparators: [',', ' '],
				    minimumInputLength: 2,
				    minimumResultsForSearch: 4,
				    ajax: {
				        url: url+"/c/names",
				        dataType: "json",
				        type: "GET",
				        data: function (params) {
				            var queryParameters = {
				                term: params.term
				            }
				            return queryParameters;
				        },
				        processResults: function (data) {
				            return {
				                results: $.map(data, function (item) {
				                    return {
				                        text: item.versionProductName,
				                        id: item.versionProductName
				                    }
				                })
				            };
				        }
				    }
				});
			}
			function getVersionWeek() {
				$.ajax({
					url: url+"/v/count/dow?componentNameParam="+componentNameParam,
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						renderVersionWeek(res);
					}
				});	
			}
			function getVersionMonth() {
				$.ajax({
					url: url+"/v/count/dom?componentNameParam="+componentNameParam,
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						renderVersionMonth(res);
					}
				});	
			}
			function getVersionYear() {
				$.ajax({
					url: url+"/v/count/moy?componentNameParam="+componentNameParam,
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						renderVersionYear(res);
					}
				});	
			}
			function getVersionList() {
				$.ajax({
					url: url+"/v?pageNumParam="+pageNumParam+"&componentNameParam="+componentNameParam,
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						// groupVersionListByComponent(res);
						renderVersionList(res);
					}
				});
			}
			function getVersionCount() {
				$.ajax({
					url: url+"/v/count",
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						renderVersionCount(res);
					}
				});	
			}
			function getComponentCount() {
				$.ajax({
					url: url+"/c/count",
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						return renderComponentCount(res);
					}
				});	
			}
			function getTodayDate() {
				renderTodayDate(new Date().toLocaleDateString());
			}
			function renderTodayDate(today) {
				$(".getTodayDate").text(today);
			}
			function renderVersionCount(res) {
				$(".getVersionCount").text(res+" versions");
			}
			function renderComponentCount(res) {
				$(".getComponentCount").text(res+" components");
			}
			function renderVersionWeek(res) {
				if (weekChart) {
					weekChart.destroy();
				}
				weekChart = new Chart(versionWeekChartId, {
				    type: 'bar',
				    data: {
				        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
				        datasets: [{
				            label: 'Number or Releases per Day of Week (' + res.reduce((a, b) => a + b, 0) + ' versions)',
				            data: res,
				            backgroundColor: [
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)'
				            ],
				            borderColor: [
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa'
				            ],
				            borderWidth: 1
				        }]
				    },
				    options: {
				        scales: {
				            yAxes: [{
				                ticks: {
				                    beginAtZero: true
				                }
				            }]
				        }
				    }
				});	
			}
			function renderVersionMonth(res) {
				if (monthChart) {
					monthChart.destroy();
				}
				monthChart = new Chart(versionMonthChartId, {
				    type: 'bar',
				    data: {
				        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 
				        		'11', '12', '13', '14', '15', '16', '17', '18', '19', '20',
				        		'21', '22', '23', '24', '25', '26', '27', '28', '29', '20',
				        		'31'],
				        datasets: [{
				            label: 'Number or Releases per Day of Month (' + res.reduce((a, b) => a + b, 0) + ' versions)',
				            data: res,
				            backgroundColor: [
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)',
								'rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)','rgba(54, 162, 235, 0.2)'		             		
				            ],
				            borderColor: [
				                '#aaa','#aaa','#aaa','#aaa',
			                	'#aaa','#aaa','#aaa','#aaa',
				                '#aaa','#aaa','#aaa','#aaa',
			                	'#aaa','#aaa','#aaa','#aaa',		
				                '#aaa','#aaa','#aaa','#aaa',
			                	'#aaa','#aaa','#aaa','#aaa',
				                '#aaa','#aaa','#aaa','#aaa',
			                	'#aaa','#aaa','#aaa'                 
				            ],
				            borderWidth: 1
				        }]
				    },
				    options: {
				        scales: {
				            yAxes: [{
				                ticks: {
				                    beginAtZero: true
				                }
				            }]
				        }
				    }
				});	
			}
			function renderVersionYear(res) {
				if (yearChart) {
					yearChart.destroy();
				}
				yearChart = new Chart(versionYearChartId, {
				    type: 'bar',
				    data: {
				        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
				        datasets: [{
				            label: 'Number or Releases per Month of Year (' + res.reduce((a, b) => a + b, 0) + ' versions)',
				            data: res,
				            backgroundColor: [
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)',
				                'rgba(54, 162, 235, 0.2)'
				            ],
				            borderColor: [
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa',
				                '#aaa'
				            ],
				            borderWidth: 1
				        }]
				    },
				    options: {
				        scales: {
				            yAxes: [{
				                ticks: {
				                    beginAtZero: true
				                }
				            }]
				        }
				    }
				});	
			}
			function renderVersionList(res) {
				for (var i = 0; i < res.length; i++) {

					var avatar = res[i].versionProductType;
					var isCve = res[i].versionReleaseChannel == "cve" ? true : false;

					if(avatar && avatar != "OS") {
						avatar = '<img class="avatar" src="https://avatars3.githubusercontent.com/u/'+avatar+'"></img>';
					} else if (isCve) {
						avatar = '<img class="avatar" src="./img/cve.png"></img>';
					} else {
						avatar = '<img class="avatar" src="./img/default.png"></img>';
					}

					if (currDate != res[i].versionReleaseDate) {
						$(".versionListClassSection").append('<li><h3>'+formatDate(res[i].versionReleaseDate)+'</h3></li>');
						currDate = res[i].versionReleaseDate;
					}

					if (formatDate(res[i].versionReleaseDate).toLowerCase() == "today") {
						countToday++;
					}


					var versionLabel = res[i].versionProductName.substring(0,20) + " (" + res[i].versionNumber + ")"; 
					var versionReleaseNotes = res[i].versionReleaseNotes;
					var versionSearchTags = "";
					if ( res[i].versionSearchTags && res[i].versionSearchTags.length > 0 && res[i].versionSearchTags[0].length > 0) {
						for(var j = 0; j < res[i].versionSearchTags.length; j++) {
							versionSearchTags += "<br><span style='color: #aaa; font-size:10pt'>&#8594;" + res[i].versionSearchTags[j] + "</span>";
						}	
					} 
					$(".versionListClassSection").append('<li class="versionListClassSection-item">'+avatar+'<a target="_blank" href="'+versionReleaseNotes+'"><span>'+versionLabel+'</a>'+ versionSearchTags +'</li>');
					//$(".versionListClassSection").append('<li class="versionListClassSection-item"><a href="#" onclick="$(\'.component-names\').val(\''+res[i].versionProductName+'\').trigger(\'change\')">add</a> '+avatar+'<a target="_blank" href="'+versionReleaseNotes+'"><span>'+versionLabel+'</a></li>');
				}

				// console.log(countToday, res.length);
				if (countToday > 0) {
					document.title = "("+countToday+") releasetrain.io";
				} else {
					document.title = "releasetrain.io";
				}
				pageNumParam++;
			}		
			function onScroll() {
	    		if(isDisplayList && $(window).scrollTop() == $(document).height() - $(window).height()) {
					getVersionList();
		        }
			}
			function formatDate(d) {
				var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				var today = new Date();
			    var releaseDate = new Date([d.slice(0, 4), d.slice(4,6), d.slice(6,8)].join('-'));
			    if (isSameDate(releaseDate, today)) {
			    	return "Today";
			    }
			    else if (!isNaN(releaseDate.getTime())) {
			        return months[releaseDate.getMonth()] + '/' + releaseDate.getDate() + '/' + releaseDate.getFullYear();
			    }
			}
			function isSameDate(d1,d2) {
    			return d1.getFullYear() == d2.getFullYear()
        			&& d1.getMonth() == d2.getMonth()
        			&& d1.getDate() == d2.getDate();
			}
		})
		</script>
	</body>
</html>